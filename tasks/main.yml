---

- name: Set fact Debian
  set_fact:
    influxdb_dl_url: "{{influxdb_deb_dl_url}}"
    influxdb_pkg: "{{influxdb_deb_pkg}}"
    influxdb_arch: "{{influxdb_deb_arch}}"
    influxdb_version: "{{influxdb_ver.replace('.','_')}}"
    influxdb_checksums: "{{influxdb_checksums_deb}}"
  when: ansible_os_family == "Debian"
  tags:
    - influxdb

- name: Set fact RedHat
  set_fact:
    influxdb_dl_url: "{{influxdb_rpm_dl_url}}"
    influxdb_pkg: "{{influxdb_rpm_pkg}}"
    influxdb_arch: "{{influxdb_rpm_arch}}"
    influxdb_version: "{{influxdb_ver.replace('.','_')}}"
    influxdb_checksums: "{{influxdb_checksums_rpm}}"
  when: ansible_os_family == "RedHat"
  tags:
    - influxdb

- name: Set fact for md5 checksum
  set_fact:
    influxdb_checksum: "{{influxdb_checksums[influxdb_version]}}"
  tags:
    - influxdb

- name: Create influxdb group
  group:
    name: "{{influxdb_group}}"
    state: present
  tags:
    - influxdb

- name: Create influxdb user
  user:
    name: "{{influxdb_user}}"
    group: "{{influxdb_group}}"
    state: present
  tags:
    - influxdb

- name: Download version
  get_url:
    url: "{{influxdb_dl_url}}"
    dest: "{{influxdb_pkg}}"
  tags:
    - influxdb

- name: Get checksum downloaded file
  stat:
    path: "{{influxdb_pkg}}"
    get_md5: True
  register: checksum_validate
  tags:
    - influxdb

- name: Validate checksum
  fail:
    msg: The checksum is not the same
  when: checksum_validate.stat.md5 != influxdb_checksum
  tags:
    - influxdb

- name: Install package (Debian)
  command: "dpkg --skip-same-version -i {{influxdb_pkg}}"
  register: dpkg_result
  changed_when: "dpkg_result.stdout.startswith('Selecting')"
  when: ansible_os_family == "Debian"
  tags:
    - influxdb

- name: Install package (RedHat)
  yum:
    name: "{{influxdb_pkg}}"
    state: installed
  when: ansible_os_family == "RedHat"
  tags:
    - influxdb

- name: Create data dir
  file:
    path: "{{influxdb_data_dir}}"
    state: directory
    group: "{{influxdb_group}}"
    owner: "{{influxdb_user}}"
  tags:
    - influxdb

- name: Create meta dir
  file:
    path: "{{influxdb_meta_dir}}"
    state: directory
    group: "{{influxdb_group}}"
    owner: "{{influxdb_user}}"
  tags:
    - influxdb

- name: Create hh dir
  file:
    path: "{{influxdb_hh_dir}}"
    state: directory
    group: "{{influxdb_group}}"
    owner: "{{influxdb_user}}"
  tags:
    - influxdb

- name: Create wal dir
  file:
    path: "{{influxdb_wal_dir}}"
    state: directory
    group: "{{influxdb_group}}"
    owner: "{{influxdb_user}}"
  tags:
    - influxdb

- name: Create config directory
  file:
    path: "{{influxdb_config_dir}}"
    state: directory
    group: "{{influxdb_group}}"
    owner: "{{influxdb_user}}"
  tags:
    - influxdb

- name: Write config
  template:
    src: conf.j2
    dest: "{{influxdb_generated_config}}"
    group: "{{influxdb_group}}"
    owner: "{{influxdb_user}}"
  register: write_config
  notify:
    - restart influxdb
  tags:
    - influxdb

# TODO: Find out why this doesn't work
# TODO: Update to use Ansible 2.0 run as instead of sudo
- name: Run config update
  command: "sudo {{influxdb_influxd_bin}} config -config {{influxdb_generated_config}}"
  register: influxdb_merged_config
  when: write_config | changed
  tags:
    - influxdb

- name: Write merged config
  copy:
    content: "{{influxdb_merged_config.stdout}}"
    dest: "{{influxdb_config_file}}"
    group: "{{influxdb_group}}"
    owner: "{{influxdb_user}}"
  when: influxdb_merged_config | changed
  tags:
    - influxdb

- name: Ensure directories have correct permissions
  file:
    path: "{{item }}"
    owner: "{{influxdb_user}}"
    group: "{{influxdb_group}}"
    recurse: yes
  with_items:
    - "{{influxdb_meta_dir}}"
    - "{{influxdb_data_dir}}"
    - "{{influxdb_hh_dir}}"
    - "{{influxdb_wal_dir}}"
  tags:
    - influxdb

- name: Write init.d script
  template:
    src: init.d.influxd.j2
    dest: "/etc/init.d/influxd"
    mode: 0755
  tags:
    - influxdb

- name: Start influxdb service
  service:
    name: influxd
    state: started
  tags:
    - influxdb
